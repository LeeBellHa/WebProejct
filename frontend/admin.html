<!-- backend/static/admin.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê´€ë¦¬ì í˜ì´ì§€</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 2em auto; }
    h1 { margin-bottom: 1em; }
    section { margin-bottom: 2em; }
    ul { list-style: none; padding: 0; }
    li { margin: .5em 0; display: flex; align-items: center; }
    li button { margin-left: 1em; }
  </style>
</head>
<body>
  <h1>ğŸ› ï¸ Admin Dashboard</h1>
  <button id="logout">ë¡œê·¸ì•„ì›ƒ</button>

  <!-- â†“ ì˜ˆì•½ ë‚´ì—­ ì„¹ì…˜ -->
  <section>
    <h2>ğŸ“… ì˜ˆì•½ ë‚´ì—­</h2>
    <ul id="bookingList">ë¡œë”© ì¤‘...</ul>
  </section>

  <section>
    <h2>ìŠ¹ì¸ ëŒ€ê¸° ì‚¬ìš©ì</h2>
    <ul id="pendingList">ë¡œë”© ì¤‘...</ul>
  </section>

  <section>
    <h2>ì¼ë°˜ ì‚¬ìš©ì</h2>
    <ul id="userList">ë¡œë”© ì¤‘...</ul>
  </section>

  <script>
    const token = localStorage.getItem("token");
    if (!token) {
      alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      location.href = "/index.html";
    }

    let payload;
    try {
      payload = JSON.parse(atob(token.split(".")[1]));
    } catch {
      localStorage.removeItem("token");
      alert("ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤.");
      location.href = "/index.html";
    }
    if (payload.role !== "admin") {
      alert("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
      location.href = "/index.html";
    }

    document.getElementById("logout").onclick = () => {
      localStorage.removeItem("token");
      location.href = "/index.html";
    };

    const headers = {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`
    };

    async function fetchAndRender() {
      // 0) ì „ì²´/ë‚´ ì˜ˆì•½ ë‚´ì—­ (adminì´ë©´ ì „ì²´ ì˜ˆì•½, userë©´ ë³¸ì¸ ì˜ˆì•½)
      const bookingRes = await fetch("/bookings/me", { headers });
      const bookings = await bookingRes.json();
      const bookingList = document.getElementById("bookingList");
      bookingList.innerHTML = "";
      if (bookings.length === 0) {
        bookingList.innerHTML = "<li>ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</li>";
      } else {
        bookings.forEach(b => {
          const li = document.createElement("li");
          li.textContent = `${b.date} ${b.start_time}â€“${b.end_time} / ${b.room?.name || b.room_id}`;
          bookingList.append(li);
        });
      }

      // 1) ìŠ¹ì¸ ëŒ€ê¸° ì‚¬ìš©ì
      const pendingRes = await fetch("/users/pending", { headers });
      const pendings = await pendingRes.json();
      const pendingList = document.getElementById("pendingList");
      pendingList.innerHTML = "";
      if (pendings.length === 0) {
        pendingList.innerHTML = "<li>ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</li>";
      } else {
        pendings.forEach(u => {
          const li = document.createElement("li");
          li.textContent = `${u.username} (${u.login_id})`;
          const approveBtn = document.createElement("button");
          approveBtn.textContent = "ìŠ¹ì¸";
          approveBtn.onclick = async () => {
            await fetch(`/users/${u.user_id}/approve`, {
              method: "PATCH",
              headers
            });
            fetchAndRender();
          };
          const delBtn = document.createElement("button");
          delBtn.textContent = "ì‚­ì œ";
          delBtn.onclick = async () => {
            await fetch(`/users/${u.user_id}`, {
              method: "DELETE",
              headers
            });
            fetchAndRender();
          };
          li.append(approveBtn, delBtn);
          pendingList.append(li);
        });
      }

      // 2) ì¼ë°˜ ì‚¬ìš©ì
      const usersRes = await fetch("/users/", { headers });
      const users = await usersRes.json();
      const userList = document.getElementById("userList");
      userList.innerHTML = "";
      const normals = users.filter(u => u.role === "user");
      if (normals.length === 0) {
        userList.innerHTML = "<li>ë“±ë¡ëœ ì¼ë°˜ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</li>";
      } else {
        normals.forEach(u => {
          const li = document.createElement("li");
          li.textContent = `${u.username} (${u.login_id})`;
          const delBtn = document.createElement("button");
          delBtn.textContent = "ì‚­ì œ";
          delBtn.onclick = async () => {
            await fetch(`/users/${u.user_id}`, {
              method: "DELETE",
              headers
            });
            fetchAndRender();
          };
          li.append(delBtn);
          userList.append(li);
        });
      }
    }

    fetchAndRender();
  </script>
</body>
</html>
