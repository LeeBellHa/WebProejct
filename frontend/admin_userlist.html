<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê´€ë¦¬ì - ì‚¬ìš©ì ê´€ë¦¬</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: auto; }
    h1 { text-align: center; margin-bottom: 1em; }
    .table-container { max-height: 300px; overflow-y: auto; margin-bottom: 2em; border: 1px solid #ccc; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f4f4f4; position: sticky; top: 0; }
    .actions button, .toggle-pw { margin-right: 8px; }
    #logout { float: right; }
    .password-cell { display: flex; align-items: center; }
    .password-cell button { margin-right: 8px; }
  </style>
</head>
<body>
  <h1>ğŸ› ï¸ ê´€ë¦¬ì - ì‚¬ìš©ì ê´€ë¦¬</h1>
  <button id="logout">ë¡œê·¸ì•„ì›ƒ</button>

  <section>
    <h2>ìŠ¹ì¸ ëŒ€ê¸° ì‚¬ìš©ì</h2>
    <div class="table-container">
      <table id="pendingTable">
        <thead>
          <tr>
            <th>ë¡œê·¸ì¸ ID</th>
            <th>ì´ë¦„</th>
            <th>í•™ë²ˆ</th>
            <th>ì „ê³µ</th>
            <th>ì „í™”ë²ˆí˜¸</th>
            <th>ì•¡ì…˜</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section>
    <h2>ì¼ë°˜ ì‚¬ìš©ì ëª©ë¡</h2>
    <div class="table-container">
      <table id="userTable">
        <thead>
          <tr>
            <th>ë¡œê·¸ì¸ ID</th>
            <th>ë¹„ë°€ë²ˆí˜¸</th>
            <th>ì´ë¦„</th>
            <th>í•™ë²ˆ</th>
            <th>ì „ê³µ</th>
            <th>ì „í™”ë²ˆí˜¸</th>
            <th>ì•¡ì…˜</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <script>
    // ê´€ë¦¬ì ì¸ì¦ í™•ì¸
    const token = localStorage.getItem('token');
    if (!token) {
      alert('ê´€ë¦¬ì ë¡œê·¸ì¸ í›„ ì ‘ê·¼í•˜ì„¸ìš”.');
      location.href = '/index.html';
    }
    let payload;
    try {
      payload = JSON.parse(atob(token.split('.')[1]));
    } catch {
      localStorage.removeItem('token');
      alert('ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤.');
      location.href = '/index.html';
    }
    if (payload.role !== 'admin') {
      alert('ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
      location.href = '/index.html';
    }

    document.getElementById('logout').onclick = () => {
      localStorage.removeItem('token');
      location.href = '/index.html';
    };

    const headers = {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    };

    async function loadPending() {
      const res = await fetch('/users/pending', { headers });
      if (!res.ok) return;
      const list = await res.json();
      const tbody = document.querySelector('#pendingTable tbody');
      tbody.innerHTML = '';
      if (list.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="6" class="empty">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</td>';
        tbody.appendChild(tr);
      } else {
        list.forEach(u => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${u.login_id}</td>
            <td>${u.username}</td>
            <td>${u.student_id}</td>
            <td>${u.major}</td>
            <td>${u.phone}</td>
            <td class="actions">
              <button class="approve">ìŠ¹ì¸</button>
              <button class="delete">ì‚­ì œ</button>
            </td>
          `;
          tr.querySelector('.approve').onclick = async () => {
            await fetch(`/users/${u.user_id}/approve`, { method: 'PATCH', headers });
            loadAll();
          };
          tr.querySelector('.delete').onclick = async () => {
            if (!confirm('ì •ë§ ì´ ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            await fetch(`/users/${u.user_id}`, { method: 'DELETE', headers });
            loadAll();
          };
          tbody.appendChild(tr);
        });
      }
    }

    async function loadUsers() {
      const res = await fetch('/users', { headers });
      if (!res.ok) return;
      const list = await res.json();
      const normals = list.filter(u => u.role === 'user');
      const tbody = document.querySelector('#userTable tbody');
      tbody.innerHTML = '';
      if (normals.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="7" class="empty">ë“±ë¡ëœ ì¼ë°˜ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</td>';
        tbody.appendChild(tr);
      } else {
        normals.forEach(u => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${u.login_id}</td>
            <td class="password-cell">
              <button class="toggle-pw">ë³´ê¸°</button>
              <span class="plain" style="display:none;">${u.password}</span>
            </td>
            <td>${u.username}</td>
            <td>${u.student_id}</td>
            <td>${u.major}</td>
            <td>${u.phone}</td>
            <td class="actions">
              <button class="delete">ì‚­ì œ</button>
            </td>
          `;
          // ë¹„ë°€ë²ˆí˜¸ í† ê¸€ ê¸°ëŠ¥
          tr.querySelector('.toggle-pw').onclick = () => {
            const plain = tr.querySelector('.plain');
            const btn = tr.querySelector('.toggle-pw');
            if (plain.style.display === 'none') {
              plain.style.display = '';
              btn.textContent = 'ê°€ë¦¬ê¸°';
            } else {
              plain.style.display = 'none';
              btn.textContent = 'ë³´ê¸°';
            }
          };
          tr.querySelector('.delete').onclick = async () => {
            if (!confirm('ì •ë§ ì´ ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            await fetch(`/users/${u.user_id}`, { method: 'DELETE', headers });
            loadAll();
          };
          tbody.appendChild(tr);
        });
      }
    }

    function loadAll() {
      loadPending();
      loadUsers();
    }

    // ì´ˆê¸° ë¡œë“œ
    loadAll();
  </script>
</body>
</html>
