<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë¡œê·¸ì¸</title>
</head>
<body>
  <h1>ë¡œê·¸ì¸</h1>

  <!-- ìµœì‹  ê³µì§€ì‚¬í•­ -->
  <h2>ğŸ“° ìµœì‹  ê³µì§€ì‚¬í•­</h2>
  <ul id="public-notice-list"></ul>

  <form id="loginForm">
    <label>Login ID: <input name="login_id" required /></label><br/>
    <label>Password: <input type="password" name="password" required /></label><br/>
    <button type="submit">ë¡œê·¸ì¸</button>
  </form>

  <p>
    ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?
    <button id="goRegister">íšŒì›ê°€ì…</button>
  </p>

  <script>
    // ê³µì§€ì‚¬í•­ ë¡œë“œ
    async function loadPublicNotices() {
      try {
        const res = await fetch('/api/notices');
        if (!res.ok) return;
        const ul = document.getElementById('public-notice-list');
        ul.innerHTML = '';
        (await res.json()).forEach(n => {
          const li = document.createElement('li');
          li.textContent = `[${n.created_at.split('T')[0]}] ${n.content}`;
          ul.appendChild(li);
        });
      } catch (err) {
        console.error('ê³µì§€ ë¡œë”© ì‹¤íŒ¨', err);
      }
    }

    // ë¡œê·¸ì¸ ì²˜ë¦¬
    const form = document.getElementById("loginForm");
    form.addEventListener("submit", async e => {
      e.preventDefault();
      const data = new URLSearchParams({
        username: form.login_id.value,
        password: form.password.value
      });
      const res = await fetch("/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: data
      });
      if (!res.ok) {
        const err = await res.json();
        alert(err.detail || "ë¡œê·¸ì¸ ì‹¤íŒ¨");
        return;
      }
      const { access_token, role } = await res.json();
      if (role === "pending") {
        alert("ì•„ì§ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ê³„ì •ì…ë‹ˆë‹¤.");
        return;
      }
      localStorage.setItem("token", access_token);
      if (role === "admin") location.href = "/admin.html";
      else location.href = "/user.html";
    });

    document.getElementById("goRegister")
      .addEventListener("click", () => location.href = "/register_test.html");

    // ì´ˆê¸°í™”
    document.addEventListener("DOMContentLoaded", loadPublicNotices);
  </script>
</body>
</html>
