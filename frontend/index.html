<!-- index.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë¡œê·¸ì¸</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1, h2 { color: #333; }
    ul { list-style: none; padding: 0; }
    li { margin-bottom: 5px; }
    a.notice-link { color: #007BFF; text-decoration: none; }
  </style>
</head>
<body>
  <h1>ë¡œê·¸ì¸</h1>

  <!-- ìµœì‹  ê³µì§€ì‚¬í•­ -->
  <h2>ğŸ“° ìµœì‹  ê³µì§€ì‚¬í•­</h2>
  <ul id="public-notice-list"></ul>

  <form id="loginForm">
    <label>Login ID: <input name="login_id" required /></label><br/>
    <label>Password: <input type="password" name="password" required /></label><br/>
    <button type="submit">ë¡œê·¸ì¸</button>
  </form>

  <p>
    ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?
    <button id="goRegister">íšŒì›ê°€ì…</button>
  </p>

  <script>
    // 1) ê³µì§€ ëª©ë¡ë§Œ ì œëª©ìœ¼ë¡œ ë Œë” (ë§í¬ë¡œë§Œ ì´ë™)
    async function loadPublicNotices() {
      try {
        const res = await fetch('/api/notices');
        if (!res.ok) return;
        const list = await res.json();
        const ul = document.getElementById('public-notice-list');
        ul.innerHTML = '';
        list.forEach(n => {
          const li = document.createElement('li');
          li.innerHTML = `
            [${n.created_at.split('T')[0]}]
            <a class="notice-link" href="notice.html?id=${n.notice_id}">
              ${n.title}
            </a>
          `;
          ul.appendChild(li);
        });
      } catch (err) {
        console.error('ê³µì§€ ë¡œë”© ì‹¤íŒ¨', err);
      }
    }

    // ë¡œê·¸ì¸ ì²˜ë¦¬ (ë³€ê²½ ì—†ìŒ)
    const form = document.getElementById("loginForm");
    form.addEventListener("submit", async e => {
      e.preventDefault();
      const data = new URLSearchParams({
        username: form.login_id.value,
        password: form.password.value
      });
      const res = await fetch("/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: data
      });
      if (!res.ok) {
        const err = await res.json();
        return alert(err.detail || "ë¡œê·¸ì¸ ì‹¤íŒ¨");
      }
      const { access_token, role } = await res.json();
      if (role === "pending") {
        return alert("ì•„ì§ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ê³„ì •ì…ë‹ˆë‹¤.");
      }
      localStorage.setItem("token", access_token);
      location.href = role === "admin" ? "/admin.html" : "/user.html";
    });

    document.getElementById("goRegister")
      .addEventListener("click", () => location.href = "/register_test.html");

    document.addEventListener("DOMContentLoaded", loadPublicNotices);
  </script>
</body>
</html>
